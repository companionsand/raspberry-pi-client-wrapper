[Unit]
Description=Kin AI Agent Launcher
Documentation=https://github.com/companionsand/raspberry-pi-client
After=network-online.target otelcol.service
Wants=network-online.target
Requires=otelcol.service

[Service]
Type=simple
User=pi
WorkingDirectory=/home/pi/raspberry-pi-client-wrapper
ExecStart=/home/pi/raspberry-pi-client-wrapper/launch.sh

# Ensure the PipeWire/PulseAudio sockets and DBus session are available even
# when running headless via systemd at boot.
EnvironmentFile=/etc/default/agent-launcher
ExecStartPre=/bin/bash -c 'SOCKET_PATH="${PULSE_SOCKET_PATH:-${PULSE_SERVER#unix:}}"; for i in $(seq 1 20); do [ -n "$SOCKET_PATH" ] && [ -S "$SOCKET_PATH" ] && exit 0; sleep 1; done; echo "PulseAudio socket not ready at ${SOCKET_PATH:-unknown}" >&2; exit 1'

# Auto-restart on crash/failure
Restart=always
RestartSec=10
StartLimitIntervalSec=0
StartLimitBurst=0

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=agent-launcher

# Environment
Environment="PATH=/usr/local/bin:/usr/bin:/bin"

# Resource limits
MemoryMax=512M
CPUQuota=100%

# Ensure service keeps running
KillMode=control-group
TimeoutStopSec=30

[Install]
WantedBy=multi-user.target
