# Raspberry Pi Client Wrapper

A comprehensive wrapper for deploying and managing the Kin AI Raspberry Pi client. This wrapper handles all dependencies, services, and automatic updates.

## Simplified Device Authentication

**The installation process is now much simpler!** With the new device authentication system:

- **Only 2 environment variables needed**: `DEVICE_ID` and `DEVICE_PRIVATE_KEY`
- **No API keys required on device**: All keys fetched from backend automatically
- **Provision via admin portal**: Download pre-configured installer package
- **Centralized management**: Update API keys without touching devices

### How It Works

1. **Admin Portal**: Provision device → generates keys → download installer zip
2. **Device**: Unzip → run `./install.sh` → everything auto-configured
3. **Runtime**: Device authenticates → fetches all API keys and settings from backend

## Overview

This wrapper automates the setup and management of the Kin AI voice assistant client on Raspberry Pi with ReSpeaker. It handles:

- System dependency installation
- OpenTelemetry collector setup with persistent logging
- Automatic code updates from git
- Systemd service management for auto-start on boot
- Python virtual environment and dependency management
- Device authentication with automatic key fetching

## Architecture

```
raspberry-pi-client-wrapper/
├── install.sh                 # One-time installation script
├── launch.sh                  # Runtime launcher (run by systemd)
├── uninstall.sh               # Uninstallation script
├── reinstall.sh               # Reinstall script
├── monitor/
│   └── device_monitor.sh      # Remote intervention monitor
├── respeaker/
│   ├── respeaker-init.sh      # ReSpeaker tuning initialization
│   └── RESPEAKER_TUNING.md    # ReSpeaker configuration guide
├── otel/
│   ├── install-collector.sh   # OpenTelemetry collector installer
│   ├── otel-collector-config.yaml
│   └── .cache/                # Downloaded tarballs (gitignored)
├── services/
│   └── agent-launcher.service # Systemd service template
├── raspberry-pi-client/       # Git cloned here (gitignored)
└── README.md                  # This file
```

## Prerequisites

### Hardware

- Raspberry Pi 5 (recommended) or Pi 4
- ReSpeaker 4-Mic Array (with hardware AEC)
- MicroSD card (32GB+ recommended)
- Stable internet connection

### Software

- Raspberry Pi OS Lite (64-bit) or Desktop
- Fresh system or clean install recommended

## Quick Start

### Option A: Admin Portal Provisioning (Recommended)

**This is the easiest method!** The installer package is generated by the admin portal with all credentials pre-configured.

1. **Provision device in admin portal**:

   - Go to Device Management → Unregistered Devices
   - Click "Provision New Device"
   - Enter device name, serial number, and Picovoice key
   - Download installer package (zip file)

2. **Copy to Raspberry Pi**:

   ```bash
   # On your computer
   scp raspberry-pi-client-wrapper-<device-id>.zip pi@raspberrypi.local:~/

   # On the Pi
   ssh pi@raspberrypi.local
   cd ~
   unzip raspberry-pi-client-wrapper-<device-id>.zip
   cd raspberry-pi-client-wrapper
   ```

3. **Run installation** - completely automated:

   ```bash
   ./install.sh
   # Everything pre-configured! No prompts needed.
   ```

4. **Done!**
   - Device automatically authenticates
   - All API keys fetched from backend
   - Services start automatically

The `.env` file is already included with:

```bash
DEVICE_ID=<auto-generated-uuid>
DEVICE_PRIVATE_KEY=<generated-key>
OTEL_CENTRAL_COLLECTOR_ENDPOINT=<your-endpoint>
ENV=production

# Optional (defaults apply if not set):
# GIT_BRANCH=main  (default: main)
```

### Option B: Manual Installation

For manual setup without the admin portal:

1. **Create `.env` file** with:

   ```bash
   DEVICE_ID=your-device-id
   DEVICE_PRIVATE_KEY=your-private-key
   ENV=production
   OTEL_CENTRAL_COLLECTOR_ENDPOINT=https://your-collector.onrender.com:4318
   ```

2. **Run installation**:
   ```bash
   ./install.sh
   ```

### Option C: Interactive Installation

If you prefer to enter values during installation:

1. **Copy Wrapper to Pi**:

   ```bash
   # On your development machine:
   scp -r raspberry-pi-client-wrapper pi@raspberrypi.local:~/
   ```

2. **Run Installation Script**:

   ```bash
   ssh pi@raspberrypi.local
   cd ~/raspberry-pi-client-wrapper
   chmod +x install.sh
   ./install.sh
   ```

The installer will:

1. Check system compatibility
2. Install system dependencies (Python, ALSA, audio libraries)
3. Clone the raspberry-pi-client repository
4. Create Python virtual environment
5. Install Python requirements
6. Prompt for configuration (Device ID, OTEL endpoint, Environment)
7. Setup OpenTelemetry Collector with systemd service
8. Setup agent-launcher systemd service (with auto-restart)
9. Create .env template files

**Installation takes 5-10 minutes** depending on your Pi model and internet speed.

### View Logs

```bash
# Agent launcher logs (main application)
sudo journalctl -u agent-launcher -f

# OpenTelemetry Collector logs
sudo journalctl -u otelcol -f

# Combined view
sudo journalctl -u agent-launcher -u otelcol -f
```

## How It Works

### Auto-Restart on Crash

**The system is configured for maximum reliability:**

- If `main.py` crashes or errors out, systemd automatically restarts it
- No limit on restart attempts - it will keep trying indefinitely
- 10-second delay between restart attempts
- Restarts are logged in systemd journal

This ensures your device stays online even after:

- Python exceptions
- Network failures
- Temporary service disruptions
- System resource issues

### Boot Sequence

When the Raspberry Pi boots:

1. **Network Wait**: `agent-launcher.service` waits for network-online.target
2. **OTEL Start**: OpenTelemetry Collector starts (dependency)
3. **Launch Script**: `launch.sh` is executed by systemd

### Launch Script Flow

The `launch.sh` script runs on every boot:

```
1. Check Internet Connection
   ├─ Ping 8.8.8.8 with retries
   └─ Exit if no connection after 30 attempts

2. Update Code
   ├─ Clone repo if not exists
   └─ Git pull latest changes if exists

3. Setup Python Environment
   ├─ Create venv if not exists
   └─ Activate venv

4. Install Dependencies
   └─ pip install -r requirements.txt

5. Verify Configuration
   └─ Check .env file exists

6. Initialize ReSpeaker
   └─ Apply tuning parameters

7. Run Client
   └─ exec python main.py
```

### Services Overview

| Service                  | Type   | Purpose                   | Auto-Start | Auto-Restart      |
| ------------------------ | ------ | ------------------------- | ---------- | ----------------- |
| `otelcol.service`        | System | OpenTelemetry Collector   | Yes        | Yes               |
| `agent-launcher.service` | System | Client Launcher & Updater | Yes        | Yes (unlimited)   |

## ReSpeaker Configuration

The wrapper assumes you're using a ReSpeaker 4-Mic Array with hardware acoustic echo cancellation (AEC). The `respeaker-init.sh` script runs on every boot to configure optimal tuning parameters.

### ReSpeaker Tuning

The following parameters are configured automatically:

- **AGCGAIN**: Microphone gain (default: 5.0)
- **AGCONOFF**: AGC freeze (default: 0 - frozen to prevent auto-adjustment)
- **AECFREEZEONOFF**: AEC adaptation (default: 0 - enabled)
- **ECHOONOFF**: Echo suppression (default: 1 - enabled)

You can override these via environment variables:

```bash
export RESPEAKER_AGCGAIN=5.0
export RESPEAKER_AGCONOFF=0
export RESPEAKER_AECFREEZEONOFF=0
export RESPEAKER_ECHOONOFF=1
```

### ReSpeaker Setup

Before running the installer, clone the ReSpeaker tuning tools:

```bash
cd ~
git clone https://github.com/respeaker/usb_4_mic_array.git
```

## Manual Operations

### Manually Update Code

```bash
cd ~/raspberry-pi-client-wrapper/raspberry-pi-client
git pull origin main
sudo systemctl restart agent-launcher
```

### Reinstall Dependencies

```bash
cd ~/raspberry-pi-client-wrapper/raspberry-pi-client
source venv/bin/activate
pip install -r requirements.txt --force-reinstall
```

### Reset to Fresh State

```bash
# Stop services
sudo systemctl stop agent-launcher
sudo systemctl stop otelcol

# Remove cloned repository
rm -rf ~/raspberry-pi-client-wrapper/raspberry-pi-client

# Restart (will re-clone)
sudo systemctl start agent-launcher
```

## Troubleshooting

### Agent Won't Start

**Check logs:**

```bash
sudo journalctl -u agent-launcher -n 50
```

**View restart history:**

```bash
# See how many times the service has restarted
sudo systemctl status agent-launcher

# Watch for restart events in real-time
sudo journalctl -u agent-launcher -f
```

**Common issues:**

- `.env` file not configured
- No internet connection
- Python dependencies failed to install
- Invalid credentials
- Repeated crashes (check Python error messages in logs)

### Audio Issues

**List ALSA devices:**

```bash
aplay -l   # List playback devices
arecord -l # List capture devices
```

**Test speaker:**

```bash
speaker-test -c2 -t wav
```

**Test microphone:**

```bash
arecord -d 5 test.wav && aplay test.wav
```

### OpenTelemetry Collector Issues

**Check status:**

```bash
sudo systemctl status otelcol
sudo journalctl -u otelcol -n 50
```

**Validate config:**

```bash
sudo /usr/local/bin/otelcol --config=/etc/otelcol/config.yaml validate
```

### Code Not Updating

**Force update:**

```bash
cd ~/raspberry-pi-client-wrapper/raspberry-pi-client
git fetch origin main
git reset --hard origin/main
sudo systemctl restart agent-launcher
```

### Service Won't Start on Boot

**Check service status:**

```bash
sudo systemctl is-enabled agent-launcher
sudo systemctl is-enabled otelcol
```

**Re-enable:**

```bash
sudo systemctl enable agent-launcher
sudo systemctl enable otelcol
sudo systemctl daemon-reload
```

## Development Mode

To run the client manually (not as a service):

```bash
# Stop the service
sudo systemctl stop agent-launcher

# Activate venv and run
cd ~/raspberry-pi-client-wrapper/raspberry-pi-client
source venv/bin/activate
python main.py

# When done, restart service
sudo systemctl start agent-launcher
```

## Uninstallation

### Quick Uninstall

To completely remove the wrapper and all services:

#### Interactive Mode (Default)

```bash
cd ~/raspberry-pi-client-wrapper
./uninstall.sh
```

#### Automated Mode (No Prompts)

```bash
cd ~/raspberry-pi-client-wrapper
./uninstall.sh --auto-yes
# or
./uninstall.sh -y
```

The uninstall script will:

1. Stop all services (agent-launcher, otelcol)
2. Disable all services
3. Remove service files from systemd
4. Remove OpenTelemetry Collector (binary, configs, data)
5. Remove cloned repository and virtual environment
6. **Prompt** to remove wrapper directory (optional)
7. **Prompt** to remove cached downloads (optional)
8. **Prompt** to remove system packages (optional)
9. **Prompt** to reboot (optional)

### What Gets Removed

**Always removed:**

- All systemd services
- OpenTelemetry Collector
- Cloned raspberry-pi-client repository
- Python virtual environment

**Optional (prompted):**

- Wrapper directory with scripts
- System packages (pip, alsa-utils, etc.)

**Preserved:**

- System journal logs (can be manually cleared)

## Configuration Reference

### Git Repository

- **URL**: `https://github.com/companionsand/raspberry-pi-client.git` (HTTPS - public repo)
- **Branch**: Configurable via `GIT_BRANCH` in `.env` (default: `main`)
- **Clone Location**: `~/raspberry-pi-client-wrapper/raspberry-pi-client/`
- **Authentication**: None required (public repository)

### Paths

- **Wrapper**: `~/raspberry-pi-client-wrapper/`
- **Client**: `~/raspberry-pi-client-wrapper/raspberry-pi-client/`
- **Venv**: `~/raspberry-pi-client-wrapper/raspberry-pi-client/venv/`
- **Client .env**: `~/raspberry-pi-client-wrapper/raspberry-pi-client/.env`
- **Cache**: `~/raspberry-pi-client-wrapper/otel/.cache/` (OpenTelemetry tarball)
- **OTEL Config**: `/etc/otelcol/config.yaml`
- **OTEL Env**: `/etc/otelcol/otelcol.env`

### Service Files

- **Agent Launcher**: `/etc/systemd/system/agent-launcher.service`
- **OTEL Collector**: `/etc/systemd/system/otelcol.service`

## Performance Optimizations

### Cached Downloads

The installer caches downloaded files to speed up reinstallations:

**Location**: `~/raspberry-pi-client-wrapper/otel/.cache/`

**What's cached:**

- OpenTelemetry Collector tarball (~40MB)

**Benefits:**

- First installation: Downloads from internet
- Subsequent installations: Uses cached file (10x faster)
- Works offline after first download
- Preserves bandwidth

**Cache management:**

```bash
# Check cache size
du -sh ~/raspberry-pi-client-wrapper/otel/.cache

# Clear cache manually
rm -rf ~/raspberry-pi-client-wrapper/otel/.cache

# Uninstaller asks if you want to remove cache
# (Keeping it speeds up future reinstalls)
```

## Support

If you encounter issues:

1. Check service logs with `journalctl`
2. Verify configuration files are correct
3. Ensure internet connectivity
4. Check system resources (disk space, memory)

## License

Copyright © 2025 Kin AI. All rights reserved.
